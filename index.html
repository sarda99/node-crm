<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-active {
            background-color: #E5E7EB; /* bg-gray-200 */
            color: #1F2937; /* text-gray-800 */
        }
        .table-row-hover:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .kanban-column {
            min-height: 400px;
        }
        .deal-card {
            cursor: grab;
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-style: dashed;
            border-color: #3B82F6; /* blue-500 */
        }
        .task-item.completed span {
            text-decoration: line-through;
            color: #6B7280; /* text-gray-500 */
        }
        .setting-node-item.active {
            background-color: #DBEAFE; /* blue-100 */
            border-left-color: #3B82F6; /* blue-500 */
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main App Screen -->
    <div id="app" class="relative min-h-screen md:flex">
        <!-- Mobile menu overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-gray-900">My CRM</h1>
            </div>
            <nav id="main-nav" class="flex-1 px-4 space-y-2">
                <!-- Dynamic navigation will be rendered here -->
            </nav>
            <div class="p-4 border-t">
                <a href="#" data-view="settings" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-200"><i data-feather="settings" class="w-5 h-5"></i><span class="ml-3">Settings</span></a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
             <!-- Top bar for mobile -->
            <header class="md:hidden bg-white shadow-sm p-4 flex justify-between items-center">
                <button id="menu-btn" class="text-gray-600 hover:text-gray-900">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="mobile-header-title" class="text-xl font-bold">Dashboard</h2>
            </header>
            <main class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
                <div id="content">
                    <!-- Views will be rendered here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals">
        <!-- Generic Node Modal -->
        <div id="node-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-md">
                <h3 id="node-modal-title" class="text-2xl font-bold mb-6"></h3>
                <form id="node-form">
                    <input type="hidden" id="node-id">
                    <input type="hidden" id="node-type">
                    <div id="node-form-fields" class="space-y-4"></div>
                    <div class="flex justify-end space-x-4 mt-8"><button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" data-modal="node-modal">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
                </form>
            </div>
        </div>
        <!-- Task Modal -->
        <div id="task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-md">
                <h3 id="task-modal-title" class="text-2xl font-bold mb-6">Add New Task</h3>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="mb-4"><label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><input type="text" id="task-description" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                    <div class="mb-4"><label for="task-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label><input type="date" id="task-due-date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                    <div class="flex justify-end space-x-4 mt-8"><button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" data-modal="task-modal">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Task</button></div>
                </form>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const content = document.getElementById('content');
            const mainNav = document.getElementById('main-nav');
            const mobileHeaderTitle = document.getElementById('mobile-header-title');
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // --- APP STATE ---
            let currentView = 'dashboard';
            let nodes, tasksData, activityLog;
            let selectedSettingsNode = null;

            // --- DEFAULTS & PERSISTENCE ---
            const defaultNodes = { 
                Leads: { 
                    view: 'table', 
                    icon: 'users', 
                    isCore: true, 
                    fields: [ 
                        { name: 'Name', type: 'text', required: true, isCore: true }, 
                        { name: 'Email', type: 'email', required: true, isCore: true }, 
                        { name: 'Company', type: 'text', required: false, isCore: false } 
                    ], 
                    data: [
                        { id: 1, Name: 'Themba Nkosi', Email: 'themba.n@fnb.co.za', Company: 'FNB' },
                        { id: 2, Name: 'Sarah Chen', Email: 'sarah.chen@vodacom.co.za', Company: 'Vodacom' },
                        { id: 3, Name: 'David Miller', Email: 'david.m@eskom.co.za', Company: 'Eskom' },
                        { id: 4, Name: 'Lerato Mokoena', Email: 'lerato.m@mtn.co.za', Company: 'MTN' },
                        { id: 5, Name: 'Pieter van der Merwe', Email: 'pieter.v@sanlam.co.za', Company: 'Sanlam' },
                        { id: 6, Name: 'Naledi Khumalo', Email: 'naledi.k@discovery.co.za', Company: 'Discovery' }
                    ], 
                    nextId: 7 
                }, 
                Deals: { 
                    view: 'kanban', 
                    icon: 'dollar-sign', 
                    isCore: true, 
                    fields: [ 
                        { name: 'Name', type: 'text', required: true }, 
                        { name: 'Company', type: 'text', required: true }, 
                        { name: 'Value', type: 'number', required: true } 
                    ], 
                    stages: ['Lead', 'Contact Made', 'Proposal Sent', 'Won'], 
                    data: [
                        { id: 1, Name: 'Cloud Migration', Company: 'FNB', Value: 50000, stage: 'Contact Made' },
                        { id: 2, Name: 'Network Upgrade', Company: 'Vodacom', Value: 75000, stage: 'Proposal Sent' },
                        { id: 3, Name: 'Power Grid Analytics', Company: 'Eskom', Value: 120000, stage: 'Lead' },
                        { id: 4, Name: 'Mobile App Security', Company: 'MTN', Value: 60000, stage: 'Won' },
                        { id: 5, Name: 'Investment Platform', Company: 'Sanlam', Value: 95000, stage: 'Proposal Sent' },
                        { id: 6, Name: 'Health App Integration', Company: 'Discovery', Value: 82000, stage: 'Contact Made' }
                    ], 
                    nextId: 7 
                } 
            };
            const defaultTasks = [];
            const defaultActivityLog = [];

            function saveState() {
                localStorage.setItem('crm_nodes', JSON.stringify(nodes));
                localStorage.setItem('crm_tasks', JSON.stringify(tasksData));
                localStorage.setItem('crm_activity', JSON.stringify(activityLog));
            }
            function loadState() { 
                const savedNodes = localStorage.getItem('crm_nodes'); 
                const savedTasks = localStorage.getItem('crm_tasks'); 
                const savedActivity = localStorage.getItem('crm_activity');
                let loadedNodes = savedNodes ? JSON.parse(savedNodes) : JSON.parse(JSON.stringify(defaultNodes));
                if (loadedNodes.Contacts && !loadedNodes.Leads) { loadedNodes.Leads = loadedNodes.Contacts; delete loadedNodes.Contacts; }
                if (loadedNodes.Leads && loadedNodes.Leads.fields.some(f => f.name === 'Value')) { loadedNodes.Leads.fields = loadedNodes.Leads.fields.filter(f => f.name !== 'Value'); }
                nodes = loadedNodes;
                tasksData = savedTasks ? JSON.parse(savedTasks) : JSON.parse(JSON.stringify(defaultTasks)); 
                activityLog = savedActivity ? JSON.parse(savedActivity) : JSON.parse(JSON.stringify(defaultActivityLog));
            }
            function logActivity(message) { activityLog.unshift({ message, time: new Date().toISOString() }); if (activityLog.length > 20) { activityLog.pop(); } saveState(); }

            // --- MODAL & FORM LOGIC ---
            function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
            function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
            function showNodeModal(nodeName, item = null) { const node = nodes[nodeName]; const formFields = document.getElementById('node-form-fields'); document.getElementById('node-type').value = nodeName; formFields.innerHTML = node.fields.map(field => `<div><label for="node-field-${field.name}" class="block text-sm font-medium text-gray-700 mb-1">${field.name}</label><input type="${field.type}" id="node-field-${field.name}" name="${field.name}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" ${field.required ? 'required' : ''}></div>`).join(''); if (item) { document.getElementById('node-modal-title').innerText = `Edit ${nodeName.slice(0, -1)}`; document.getElementById('node-id').value = item.id; node.fields.forEach(field => { const input = document.getElementById(`node-field-${field.name}`); if (input) input.value = item[field.name] || ''; }); } else { document.getElementById('node-modal-title').innerText = `Add New ${nodeName.slice(0, -1)}`; document.getElementById('node-form').reset(); document.getElementById('node-id').value = ''; document.getElementById('node-type').value = nodeName; } showModal('node-modal'); };
            function saveNodeItem(e) { e.preventDefault(); const nodeName = document.getElementById('node-type').value; const node = nodes[nodeName]; const id = document.getElementById('node-id').value; const newItemData = {}; node.fields.forEach(field => { const input = document.getElementById(`node-field-${field.name}`); if (input) newItemData[field.name] = input.value; }); if (id) { const existingItem = node.data.find(item => item.id === parseInt(id)); const updatedItem = { ...existingItem, ...newItemData }; node.data = node.data.map(item => item.id === parseInt(id) ? updatedItem : item); } else { newItemData.id = node.nextId++; if (node.view === 'kanban') { newItemData.stage = node.stages[0]; } node.data.push(newItemData); logActivity(`New ${nodeName.slice(0,-1)} "${newItemData.Name}" created.`); } saveState(); if (node.view === 'table') { renderNodeTable(nodeName); } else if (node.view === 'kanban') { renderNodeKanban(nodeName); } hideModal('node-modal'); };
            
            // --- CORE LOGIC ---
            function convertLeadToDeal(leadId) { const leadsNode = nodes['Leads']; const dealsNode = nodes['Deals']; if (!leadsNode || !dealsNode) return; const leadIndex = leadsNode.data.findIndex(lead => lead.id === leadId); if (leadIndex === -1) return; const [leadToConvert] = leadsNode.data.splice(leadIndex, 1); const newDeal = { id: dealsNode.nextId++, Name: leadToConvert.Name, Company: leadToConvert.Company, Value: 0, stage: dealsNode.stages[0] }; dealsNode.data.push(newDeal); logActivity(`Lead "${newDeal.Name}" converted to a deal.`); saveState(); renderNodeTable('Leads'); };
            function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); }

            // --- RENDER FUNCTIONS ---
            function renderDashboard() { const leadsNode = nodes['Leads']; const dealsNode = nodes['Deals']; const totalLeads = leadsNode ? leadsNode.data.length : 0; const activeDeals = dealsNode ? dealsNode.data.filter(d => d.stage !== 'Won').length : 0; const wonValue = dealsNode ? dealsNode.data.filter(d => d.stage === 'Won').reduce((sum, d) => sum + Number(d.Value), 0) : 0; const tasksDueToday = tasksData.filter(t => !t.completed && t.dueDate === new Date().toISOString().slice(0, 10)).length; const activityHtml = activityLog.map(item => `<li class="border-b border-gray-200 py-2"><p class="text-sm text-gray-800">${item.message}</p><p class="text-xs text-gray-500">${new Date(item.time).toLocaleString()}</p></li>`).join(''); content.innerHTML = ` <h2 class="text-3xl font-bold mb-6">Dashboard</h2> <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6"> <div class="bg-white p-6 rounded-lg shadow"> <div class="flex items-center"> <div class="bg-blue-100 p-3 rounded-full"><i data-feather="users" class="text-blue-500"></i></div> <div class="ml-4"> <p class="text-sm text-gray-500">Total Leads</p> <p class="text-2xl font-bold">${totalLeads}</p> </div> </div> </div> <div class="bg-white p-6 rounded-lg shadow"> <div class="flex items-center"> <div class="bg-yellow-100 p-3 rounded-full"><i data-feather="dollar-sign" class="text-yellow-500"></i></div> <div class="ml-4"> <p class="text-sm text-gray-500">Active Deals</p> <p class="text-2xl font-bold">${activeDeals}</p> </div> </div> </div> <div class="bg-white p-6 rounded-lg shadow"> <div class="flex items-center"> <div class="bg-red-100 p-3 rounded-full"><i data-feather="check-square" class="text-red-500"></i></div> <div class="ml-4"> <p class="text-sm text-gray-500">Tasks Due Today</p> <p class="text-2xl font-bold">${tasksDueToday}</p> </div> </div> </div> <div class="bg-white p-6 rounded-lg shadow"> <div class="flex items-center"> <div class="bg-green-100 p-3 rounded-full"><i data-feather="trending-up" class="text-green-500"></i></div> <div class="ml-4"> <p class="text-sm text-gray-500">Revenue (Won)</p> <p class="text-2xl font-bold">$${wonValue.toLocaleString()}</p> </div> </div> </div> </div> <div class="mt-8 grid grid-cols-1 gap-6"> <div class="bg-white p-6 rounded-lg shadow"> <h3 class="font-semibold mb-4">Recent Activity</h3> <ul id="activity-feed" class="h-64 overflow-y-auto">${activityHtml}</ul> </div> </div> `; feather.replace(); };
            function renderNavigation() { const nodeLinks = Object.keys(nodes).map(nodeName => `<a href="#" data-view="${nodeName}" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-200"><i data-feather="${nodes[nodeName].icon || 'box'}" class="w-5 h-5"></i><span class="ml-3">${nodeName}</span></a>`).join(''); mainNav.innerHTML = `<a href="#" data-view="dashboard" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-lg"><i data-feather="home" class="w-5 h-5"></i><span class="ml-3">Dashboard</span></a> ${nodeLinks} <a href="#" data-view="tasks" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-200"><i data-feather="check-square" class="w-5 h-5"></i><span class="ml-3">Tasks</span></a>`; updateActiveNav(currentView); feather.replace(); };
            function updateActiveNav(viewName) { document.querySelectorAll('#main-nav .nav-link, #app .p-4 .nav-link').forEach(l => l.classList.remove('nav-active', 'bg-gray-200')); const activeLink = document.querySelector(`.nav-link[data-view="${viewName}"]`); if (activeLink) activeLink.classList.add('nav-active', 'bg-gray-200'); };
            function renderNodeTable(nodeName, data) { const node = nodes[nodeName]; const tableContainer = document.querySelector('#content .overflow-x-auto'); if (!tableContainer) return; const tableHeaders = node.fields.map(field => `<th class="p-4">${field.name}</th>`).join(''); const tableRows = (data || node.data).map(item => { const cells = node.fields.map(field => { let value = item[field.name] || ''; if (field.type === 'number' && value) { value = `$${Number(value).toLocaleString()}`; } return `<td class="p-4 break-words">${value}</td>` }).join(''); const convertButton = (nodeName === 'Leads' && nodes['Deals']) ? `<button class="convert-lead-btn text-green-500 hover:text-green-700 mr-2" data-id="${item.id}" title="Convert to Deal"><i data-feather="arrow-right-circle" class="w-5 h-5"></i></button>` : ''; let actionButtons = `${convertButton}<button class="edit-node-item-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${item.id}" data-node="${nodeName}"><i data-feather="edit-2" class="w-5 h-5"></i></button><button class="delete-node-item-btn text-red-500 hover:text-red-700" data-id="${item.id}" data-node="${nodeName}"><i data-feather="trash-2" class="w-5 h-5"></i></button>`; return `<tr class="border-b table-row-hover">${cells}<td class="p-4"><div class="flex items-center">${actionButtons}</div></td></tr>`; }).join(''); tableContainer.innerHTML = `<table class="w-full text-left"><thead><tr class="border-b">${tableHeaders}<th class="p-4">Actions</th></tr></thead><tbody>${tableRows}</tbody></table>`; feather.replace(); };
            function renderNodeKanban(nodeName) { const node = nodes[nodeName]; const kanbanContainer = document.getElementById('kanban-board'); if (!kanbanContainer) return; kanbanContainer.innerHTML = node.stages.map(stage => `<div class="flex-1 bg-gray-200 rounded-lg p-4 kanban-column min-w-[280px]" data-stage="${stage}"><h3 class="font-bold mb-4 text-gray-700">${stage}</h3><div class="space-y-4 deal-list">${node.data.filter(item => item.stage === stage).map(item => `<div class="bg-white p-4 rounded-lg shadow deal-card" draggable="true" data-id="${item.id}" data-node="${nodeName}"><p class="font-semibold">${item.Name}</p><p class="text-sm text-gray-600">${item.Company}</p><p class="text-sm text-green-600 font-bold mt-2">$${Number(item.Value).toLocaleString()}</p></div>`).join('')}</div></div>`).join(''); feather.replace(); };
            function getNodeViewTemplate(nodeName) { const node = nodes[nodeName]; const singularName = nodeName.endsWith('s') ? nodeName.slice(0, -1) : nodeName; if (node.view === 'table') { return `<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-3xl font-bold">${nodeName}</h2><button id="add-node-item-btn" data-node="${nodeName}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center w-full sm:w-auto"><i data-feather="plus" class="w-5 h-5 mr-2"></i>Add ${singularName}</button></div><div class="bg-white p-4 sm:p-6 rounded-lg shadow"><div class="mb-4"><input type="text" id="search-node-items" data-node="${nodeName}" placeholder="Search ${nodeName.toLowerCase()}..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div class="overflow-x-auto"></div></div>`; } if (node.view === 'kanban') { return `<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-3xl font-bold">${nodeName} Pipeline</h2><button id="add-node-item-btn" data-node="${nodeName}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center w-full sm:w-auto"><i data-feather="plus" class="w-5 h-5 mr-2"></i> Add ${singularName}</button></div><div id="kanban-board" class="flex flex-col md:flex-row gap-6 overflow-x-auto pb-4"></div>`; } return ''; };
            function setupNodeViewListeners(nodeName) { content.addEventListener('click', e => { if (currentView !== nodeName) return; const addBtn = e.target.closest('#add-node-item-btn'); const editBtn = e.target.closest('.edit-node-item-btn'); const deleteBtn = e.target.closest('.delete-node-item-btn'); const convertBtn = e.target.closest('.convert-lead-btn'); const dealCard = e.target.closest('.deal-card'); if (addBtn) { showNodeModal(addBtn.dataset.node); } if (editBtn) { const item = nodes[nodeName].data.find(i => i.id === parseInt(editBtn.dataset.id)); if (item) showNodeModal(nodeName, item); } if (deleteBtn) { const item = nodes[nodeName].data.find(i => i.id === parseInt(deleteBtn.dataset.id)); if(item) logActivity(`${nodeName.slice(0,-1)} "${item.Name}" deleted.`); nodes[nodeName].data = nodes[nodeName].data.filter(i => i.id !== parseInt(deleteBtn.dataset.id)); saveState(); renderNodeTable(nodeName); } if (convertBtn) { convertLeadToDeal(parseInt(convertBtn.dataset.id)); } if (dealCard) { const item = nodes[nodeName].data.find(i => i.id === parseInt(dealCard.dataset.id)); if (item) showNodeModal(nodeName, item); } }); const searchInput = document.getElementById('search-node-items'); if (searchInput) { searchInput.addEventListener('input', e => { const searchTerm = e.target.value.toLowerCase(); const filteredData = nodes[nodeName].data.filter(item => Object.values(item).some(value => String(value).toLowerCase().includes(searchTerm))); renderNodeTable(nodeName, filteredData); }); } };
            function setupKanbanListeners(nodeName) { const kanbanBoard = document.getElementById('kanban-board'); if (!kanbanBoard) return; let draggedItemId = null; kanbanBoard.addEventListener('dragstart', e => { if (e.target.classList.contains('deal-card')) { draggedItemId = e.target.dataset.id; setTimeout(() => e.target.classList.add('dragging'), 0); } }); kanbanBoard.addEventListener('dragend', e => { if (e.target.classList.contains('deal-card')) { e.target.classList.remove('dragging'); draggedItemId = null; } }); kanbanBoard.addEventListener('dragover', e => { e.preventDefault(); const column = e.target.closest('.kanban-column'); if (column) { column.classList.add('drag-over'); } }); kanbanBoard.addEventListener('dragleave', e => { const column = e.target.closest('.kanban-column'); if (column) { column.classList.remove('drag-over'); } }); kanbanBoard.addEventListener('drop', e => { e.preventDefault(); const column = e.target.closest('.kanban-column'); if (column && draggedItemId) { column.classList.remove('drag-over'); const newStage = column.dataset.stage; const deal = nodes[nodeName].data.find(d => d.id === parseInt(draggedItemId)); if (deal && deal.stage !== newStage) { logActivity(`Deal "${deal.Name}" moved to ${newStage}.`); deal.stage = newStage; if(newStage === 'Won') deal.wonDate = new Date().toISOString(); saveState(); renderNodeKanban(nodeName); } } }); };
            function renderSettings() { const settingsContainer = document.getElementById('settings-container'); if(!settingsContainer) return; const nodeManagerHtml = Object.keys(nodes).map(nodeName => `<div class="setting-node-item flex items-center justify-between p-3 bg-white rounded-lg shadow-sm cursor-pointer border-l-4 border-transparent" data-node="${nodeName}"><span>${nodeName}</span> ${!nodes[nodeName].isCore ? `<button class="delete-node-btn text-red-500 hover:text-red-700" data-node="${nodeName}"><i data-feather="trash-2" class="w-5 h-5"></i></button>` : ''}</div>`).join(''); settingsContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-semibold mb-4 flex items-center">Create & Manage Nodes <div class="tooltip-container ml-2"><i data-feather="help-circle" class="w-4 h-4 text-gray-400 tooltip-icon"></i><span class="tooltip-text">Nodes are the main sections of your CRM, like 'Leads' or 'Deals'. Create your own to track anything!</span></div></h3><div id="settings-node-list" class="space-y-3 mb-4">${nodeManagerHtml}</div><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="new-node-name" placeholder="New Node Name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><select id="new-node-view" class="w-full sm:w-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="table">Table</option><option value="kanban">Kanban</option></select><button id="add-node-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Create</button></div></div><div id="node-specific-settings"></div>`; if (selectedSettingsNode) { renderNodeSpecificSettings(selectedSettingsNode); document.querySelector(`.setting-node-item[data-node="${selectedSettingsNode}"]`)?.classList.add('active'); } feather.replace(); };
            function renderNodeSpecificSettings(nodeName) { const node = nodes[nodeName]; const container = document.getElementById('node-specific-settings'); if (!container || !node) return; const fieldsList = node.fields.map((field, index) => `<li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span>${field.name} <span class="text-xs text-gray-500">(${field.type})</span></span> ${!field.isCore ? `<button class="delete-field-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-feather="trash-2" class="w-5 h-5"></i></button>` : ''}</li>`).join(''); const fieldsManager = `<div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-semibold mb-4">Manage Fields for ${nodeName}</h3><ul id="contact-fields-list" class="space-y-3 mb-4">${fieldsList}</ul><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="new-field-name" placeholder="Field Name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><select id="new-field-type" class="w-full sm:w-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="text">Text</option><option value="email">Email</option><option value="tel">Phone</option><option value="number">Number</option></select><button id="add-field-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add</button></div></div>`; let stagesManager = ''; if (node.view === 'kanban') { const stagesList = node.stages.map((stage, index) => `<li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span>${stage}</span> ${node.stages.length > 1 ? `<button class="delete-stage-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-feather="trash-2" class="w-5 h-5"></i></button>` : ''}</li>`).join(''); stagesManager = `<div class="bg-white p-6 rounded-lg shadow mt-8"><h3 class="text-xl font-semibold mb-4">Manage Stages for ${nodeName}</h3><ul class="space-y-3 mb-4">${stagesList}</ul><div class="flex items-center"><input type="text" id="new-stage-name" placeholder="Add new stage" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><button id="add-stage-btn" class="ml-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add</button></div></div>`; } container.innerHTML = fieldsManager + stagesManager; feather.replace(); };
            function setupSettingsViewListeners() { const container = document.getElementById('settings-container'); container.addEventListener('click', e => { const addNodeBtn = e.target.closest('#add-node-btn'); const deleteNodeBtn = e.target.closest('.delete-node-btn'); const nodeItem = e.target.closest('.setting-node-item'); if (addNodeBtn) { const nameInput = document.getElementById('new-node-name'); const viewInput = document.getElementById('new-node-view'); const nodeName = nameInput.value.trim(); if (nodeName && !nodes[nodeName]) { nodes[nodeName] = { view: viewInput.value, icon: 'box', isCore: false, fields: [{ name: 'Name', type: 'text', required: true, isCore: true }], data: [], nextId: 1 }; if (viewInput.value === 'kanban') { nodes[nodeName].stages = ['To Do', 'In Progress', 'Done']; } nameInput.value = ''; logActivity(`Created new Node: "${nodeName}".`); saveState(); renderNavigation(); renderSettings(); } } if (deleteNodeBtn) { e.stopPropagation(); const nodeName = deleteNodeBtn.dataset.node; delete nodes[nodeName]; logActivity(`Deleted Node: "${nodeName}".`); saveState(); selectedSettingsNode = null; renderNavigation(); renderSettings(); } if (nodeItem) { selectedSettingsNode = nodeItem.dataset.node; renderSettings(); } const addFieldBtn = e.target.closest('#add-field-btn'); const deleteFieldBtn = e.target.closest('.delete-field-btn'); if (addFieldBtn && selectedSettingsNode) { const nameInput = document.getElementById('new-field-name'); const typeInput = document.getElementById('new-field-type'); const newName = nameInput.value.trim(); if (newName && !nodes[selectedSettingsNode].fields.some(f => f.name === newName)) { nodes[selectedSettingsNode].fields.push({ name: newName, type: typeInput.value, required: false, isCore: false }); nameInput.value = ''; saveState(); renderNodeSpecificSettings(selectedSettingsNode); } } if (deleteFieldBtn && selectedSettingsNode) { const fieldIndex = parseInt(deleteFieldBtn.dataset.index); const fieldToDelete = nodes[selectedSettingsNode].fields[fieldIndex]; nodes[selectedSettingsNode].data.forEach(item => delete item[fieldToDelete.name]); nodes[selectedSettingsNode].fields.splice(fieldIndex, 1); saveState(); renderNodeSpecificSettings(selectedSettingsNode); } const addStageBtn = e.target.closest('#add-stage-btn'); const deleteStageBtn = e.target.closest('.delete-stage-btn'); if (addStageBtn && selectedSettingsNode) { const nameInput = document.getElementById('new-stage-name'); const newName = nameInput.value.trim(); if (newName && !nodes[selectedSettingsNode].stages.includes(newName)) { nodes[selectedSettingsNode].stages.push(newName); nameInput.value = ''; saveState(); renderNodeSpecificSettings(selectedSettingsNode); } } if (deleteStageBtn && selectedSettingsNode) { const stageIndex = parseInt(deleteStageBtn.dataset.index); const stageToDelete = nodes[selectedSettingsNode].stages[stageIndex]; nodes[selectedSettingsNode].data.forEach(item => { if (item.stage === stageToDelete) { item.stage = nodes[selectedSettingsNode].stages[0]; } }); nodes[selectedSettingsNode].stages.splice(stageIndex, 1); saveState(); renderNodeSpecificSettings(selectedSettingsNode); } }); };
            function renderTasks() { const container = document.getElementById('tasks-container'); if (!container) return; const tasksToday = tasksData.filter(t => t.dueDate === new Date().toISOString().slice(0, 10) && !t.completed); const tasksUpcoming = tasksData.filter(t => t.dueDate > new Date().toISOString().slice(0, 10) && !t.completed); const tasksCompleted = tasksData.filter(t => t.completed); const renderList = (tasks) => tasks.map(task => `<div class="flex items-center p-3 bg-white rounded-lg shadow-sm task-item ${task.completed ? 'completed' : ''}"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}><span class="ml-3 flex-1">${task.description}</span><span class="text-sm text-gray-500">${new Date(task.dueDate + 'T00:00:00').toLocaleDateString()}</span></div>`).join(''); container.innerHTML = `<div class="mb-8"><h3 class="text-xl font-semibold mb-4">Today</h3><div class="space-y-3">${renderList(tasksToday) || '<p class="text-gray-500">No tasks due today.</p>'}</div></div><div class="mb-8"><h3 class="text-xl font-semibold mb-4">Upcoming</h3><div class="space-y-3">${renderList(tasksUpcoming) || '<p class="text-gray-500">No upcoming tasks.</p>'}</div></div><div><h3 class="text-xl font-semibold mb-4">Completed</h3><div class="space-y-3">${renderList(tasksCompleted) || '<p class="text-gray-500">No completed tasks.</p>'}</div></div>`; };
            function setupTasksViewListeners() { const container = document.getElementById('content'); container.addEventListener('click', e => { if (currentView !== 'tasks') return; const addBtn = e.target.closest('#add-task-btn'); const checkbox = e.target.closest('.task-checkbox'); if (addBtn) { showModal('task-modal'); } if (checkbox) { const task = tasksData.find(t => t.id == checkbox.dataset.id); if (task) { task.completed = !task.completed; logActivity(`Task "${task.description}" marked as ${task.completed ? 'complete' : 'incomplete'}.`); } saveState(); renderTasks(); } }); };
            
            // --- ROUTER ---
            function renderView(viewName) {
                currentView = viewName;
                updateActiveNav(viewName);
                const title = viewName.charAt(0).toUpperCase() + viewName.slice(1);
                mobileHeaderTitle.textContent = title;
                
                const node = nodes[viewName];
                if (node) {
                    content.innerHTML = getNodeViewTemplate(viewName);
                    if (node.view === 'table') { renderNodeTable(viewName); setupNodeViewListeners(viewName); } 
                    else if (node.view === 'kanban') { renderNodeKanban(viewName); setupNodeViewListeners(viewName); setupKanbanListeners(viewName); }
                } else if (viewName === 'dashboard') { renderDashboard(); } 
                else if (viewName === 'tasks') { content.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Tasks</h2><button id="add-task-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i data-feather="plus" class="w-5 h-5 mr-2"></i> Add Task</button></div><div id="tasks-container"></div>`; renderTasks(); setupTasksViewListeners(); } 
                else if (viewName === 'settings') { content.innerHTML = `<h2 class="text-3xl font-bold mb-6">Settings</h2><div id="settings-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>`; renderSettings(); setupSettingsViewListeners(); }
                
                if (window.innerWidth < 768) { // md breakpoint
                    toggleSidebar();
                }
                feather.replace();
            }
            
            // --- EVENT LISTENERS ---
            document.querySelector('#app').addEventListener('click', e => { const navLink = e.target.closest('.nav-link'); if (navLink) { e.preventDefault(); selectedSettingsNode = null; renderView(navLink.dataset.view); } });
            document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => hideModal(btn.dataset.modal)));
            document.getElementById('node-form').addEventListener('submit', (e) => saveNodeItem(e));
            document.getElementById('task-form').addEventListener('submit', (e) => { e.preventDefault(); const description = document.getElementById('task-description').value; const dueDate = document.getElementById('task-due-date').value; tasksData.push({ id: Date.now(), description, dueDate, completed: false }); logActivity(`Task "${description}" created.`); saveState(); renderTasks(); hideModal('task-modal'); });
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // --- INITIAL LOAD ---
            loadState();
            renderNavigation();
            renderView('dashboard');
        });
    </script>
</body>
</html>
